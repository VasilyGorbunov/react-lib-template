# For more information, see: https://docs.gitlab.com/ee/ci/yaml/README.html#stages
default:
  image: node:latest
  tags:
    - k8s

stages:          # List of stages for jobs, and their order of execution
  - dependencies
  - test
  - build
  - release-rc
  - release

dependencies-job:
  stage: dependencies
  before_script:
    - echo "Update .npmrc..."
    - |
      {
        echo ""
        echo "//nexus.oko-itlab.ru/repository/oko-npm-proxy/:_authToken=${NPM_TOKEN}"
        echo "//nexus.oko-itlab.ru/repository/oko-npm-private/:_authToken=${NPM_TOKEN}"
      } | tee -a .npmrc
  script:
    - cat .npmrc
    - echo "Install dependencies..."
    - yarn install --frozen-lockfile
  interruptible: true
  artifacts:
    paths:
      - $CI_PROJECT_DIR/

lint-test-job:   # This job also runs in the test stage.
  stage: test    # It can run at the same time as unit-test-job (in parallel).
  script:
    - echo "Linting code..."
    - yarn lint
  interruptible: true
  dependencies:
    - dependencies-job

build-job:       # This job runs in the build stage, which runs first.
  stage: build
  script:
    - echo "Compiling the code..."
    - yarn build
  interruptible: true
  dependencies:
    - dependencies-job
  artifacts:
    paths:
      - $CI_PROJECT_DIR/

publish-rc:
  stage: release-rc
  rules:
    - if: $CI_COMMIT_TITLE =~ /(release)/
  script:
    - git config --global user.email "gitlab@example.com"
    - git config --global user.name "GitLab Pipeline"
    - yarn pub:rc
  dependencies:
    - dependencies-job
    - build-job

publish:
  stage: release
  rules:
    - if: $CI_COMMIT_BRANCH == $CI_DEFAULT_BRANCH
  script:
    - npm publish
    - git config --global user.email "you@example.com"
    - git config --global user.name "CICD GitLab"
    - git push -v https://ci:$CI_TOKEN@gitlab.oko-itlab.ru/gp/gp-dpu-frontend/ui-kit.git HEAD:master
    - git push -v https://ci:$CI_TOKEN@gitlab.oko-itlab.ru/gp/gp-dpu-frontend/ui-kit.git HEAD:master --tags
  dependencies:
    - dependencies-job
    - build-job
